<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Professionals - FundiPluss</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-tools"></i> FundiPluss
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="find-professionals.html">Find Fundis</a>
                    </li>
                    <li class="nav-item" id="authLinks">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Search Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Filter Professionals</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="filterTrade" class="form-label">Trade</label>
                        <select class="form-select" id="filterTrade">
                            <option value="">All Trades</option>
                            <option value="plumber">Plumber</option>
                            <option value="electrician">Electrician</option>
                            <option value="mechanic">Mechanic</option>
                            <option value="phone_repair">Phone Repair</option>
                            <option value="carpenter">Carpenter</option>
                            <option value="painter">Painter</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filterLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="filterLocation" placeholder="Enter location">
                    </div>
                    <div class="col-md-4">
                        <label for="filterSort" class="form-label">Sort by</label>
                        <select class="form-select" id="filterSort">
                            <option value="rating">Rating (Highest)</option>
                            <option value="experience">Experience</option>
                            <option value="rate">Hourly Rate (Lowest)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Professionals List -->
        <div class="row" id="professionalsList">
            <!-- Professionals will be loaded here -->
        </div>
    </div>

    <!-- Professional Details Modal -->
    <div class="modal fade" id="professionalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Professional Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="professionalDetails">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="bookProfessional()">Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Service Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <input type="hidden" id="requestProfessionalId">
                        
                        <div class="mb-3">
                            <label for="requestTrade" class="form-label">Service Type</label>
                            <input type="text" class="form-control" id="requestTrade" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="requestDescription" class="form-label">Describe the problem</label>
                            <textarea class="form-control" id="requestDescription" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="requestDate" class="form-label">Preferred Date</label>
                                <input type="date" class="form-control" id="requestDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="requestTime" class="form-label">Preferred Time</label>
                                <input type="time" class="form-control" id="requestTime">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="requestLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="requestLocation" placeholder="Your address" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitRequest()">Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let currentProfessional = null;
        let professionals = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadProfessionals();
            
            // Add event listeners for filters
            document.getElementById('filterTrade').addEventListener('change', filterProfessionals);
            document.getElementById('filterLocation').addEventListener('input', filterProfessionals);
            document.getElementById('filterSort').addEventListener('change', filterProfessionals);
        });
        
        async function loadProfessionals() {
            try {
                const result = await apiCall(`${API_URL}/professionals`);
                professionals = result;
                displayProfessionals(professionals);
            } catch (error) {
                console.error('Error loading professionals:', error);
            }
        }
        
        function displayProfessionals(professionals) {
            const container = document.getElementById('professionalsList');
            
            if (professionals.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5"><i class="bi bi-emoji-frown display-1"></i><h3 class="mt-3">No professionals found</h3></div>';
                return;
            }
            
            container.innerHTML = professionals.map(pro => `
                <div class="col-md-6 col-lg-4">
                    <div class="professional-card" onclick="viewProfessional(${pro.id})">
                        <div class="professional-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <h4>${pro.firstName} ${pro.lastName}</h4>
                        <p class="text-primary"><i class="bi bi-briefcase"></i> ${pro.trade}</p>
                        <div class="star-rating mb-2">
                            ${getStarRating(pro.averageRating || 0)}
                            <span class="text-muted">(${pro.totalRatings || 0} reviews)</span>
                        </div>
                        <p><i class="bi bi-geo-alt"></i> ${pro.location || 'Location not specified'}</p>
                        <p><i class="bi bi-clock"></i> ${pro.experience || 0} years experience</p>
                        <p class="h5 text-success">${formatCurrency(pro.hourlyRate)}/hr</p>
                    </div>
                </div>
            `).join('');
        }
        
        function getStarRating(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - Math.ceil(rating);
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += '<i class="bi bi-star-fill"></i>';
            if (halfStar) stars += '<i class="bi bi-star-half"></i>';
            for (let i = 0; i < emptyStars; i++) stars += '<i class="bi bi-star"></i>';
            
            return stars;
        }
        
        async function viewProfessional(id) {
            try {
                const professional = await apiCall(`${API_URL}/professionals/${id}`);
                currentProfessional = professional;
                
                // Load ratings
                const ratings = await apiCall(`${API_URL}/ratings/professional/${id}`);
                
                const modal = new bootstrap.Modal(document.getElementById('professionalModal'));
                document.getElementById('professionalDetails').innerHTML = `
                    <div class="text-center mb-4">
                        <div class="professional-avatar mx-auto">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <h3>${professional.firstName} ${professional.lastName}</h3>
                        <p class="text-primary">${professional.trade}</p>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong><i class="bi bi-clock"></i> Experience:</strong>
                            <p>${professional.experience || 0} years</p>
                        </div>
                        <div class="col-6">
                            <strong><i class="bi bi-cash"></i> Hourly Rate:</strong>
                            <p class="text-success">${formatCurrency(professional.hourlyRate)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="bi bi-geo-alt"></i> Location:</strong>
                        <p>${professional.location || 'Not specified'}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="bi bi-chat"></i> Bio:</strong>
                        <p>${professional.bio || 'No bio provided'}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="bi bi-star"></i> Ratings & Reviews</strong>
                        <div class="mt-2">
                            <div class="star-rating display-6">
                                ${getStarRating(ratings.average)}
                                <span class="h4">${ratings.average.toFixed(1)}</span>
                                <span class="text-muted">(${ratings.total} reviews)</span>
                            </div>
                        </div>
                        
                        ${ratings.ratings.length > 0 ? `
                            <div class="mt-3">
                                <h6>Recent Reviews:</h6>
                                ${ratings.ratings.slice(0, 3).map(r => `
                                    <div class="border-bottom pb-2 mb-2">
                                        <div class="star-rating">${getStarRating(r.score)}</div>
                                        <p class="mb-1">"${r.review}"</p>
                                        <small class="text-muted">- ${r.firstName} ${r.lastName}, ${formatDate(r.ratedAt)}</small>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-muted">No reviews yet</p>'}
                    </div>
                `;
                
                modal.show();
                
            } catch (error) {
                console.error('Error loading professional:', error);
            }
        }
        
        function bookProfessional() {
            if (!currentProfessional) return;
            
            const token = localStorage.getItem('token');
            if (!token) {
                showAlert('Please login to send a request', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            const user = JSON.parse(localStorage.getItem('user'));
            if (user.role !== 'customer') {
                showAlert('Only customers can send service requests', 'warning');
                return;
            }
            
            // Close professional modal
            bootstrap.Modal.getInstance(document.getElementById('professionalModal')).hide();
            
            // Open request modal
            document.getElementById('requestProfessionalId').value = currentProfessional.id;
            document.getElementById('requestTrade').value = currentProfessional.trade;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('requestDate').value = tomorrow.toISOString().split('T')[0];
            
            new bootstrap.Modal(document.getElementById('requestModal')).show();
        }
        
        async function submitRequest() {
            const requestData = {
                professionalId: document.getElementById('requestProfessionalId').value,
                trade: document.getElementById('requestTrade').value,
                description: document.getElementById('requestDescription').value,
                preferredDate: document.getElementById('requestDate').value,
                preferredTime: document.getElementById('requestTime').value,
                location: document.getElementById('requestLocation').value
            };
            
            try {
                await apiCall(`${API_URL}/requests`, 'POST', requestData);
                
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                showAlert('Request sent successfully!', 'success');
                
                // Reset form
                document.getElementById('requestForm').reset();
                
            } catch (error) {
                console.error('Error sending request:', error);
            }
        }
        
        function filterProfessionals() {
            const trade = document.getElementById('filterTrade').value;
            const location = document.getElementById('filterLocation').value.toLowerCase();
            const sortBy = document.getElementById('filterSort').value;
            
            let filtered = [...professionals];
            
            if (trade) {
                filtered = filtered.filter(p => p.trade === trade);
            }
            
            if (location) {
                filtered = filtered.filter(p => p.location && p.location.toLowerCase().includes(location));
            }
            
            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'rating') return (b.averageRating || 0) - (a.averageRating || 0);
                if (sortBy === 'experience') return (b.experience || 0) - (a.experience || 0);
                if (sortBy === 'rate') return (a.hourlyRate || 0) - (b.hourlyRate || 0);
                return 0;
            });
            
            displayProfessionals(filtered);
        }
    </script>
</body>
</html>